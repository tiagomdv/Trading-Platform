{% extends "layout.html" %}

{% block title %} Market {% endblock %}

{% block main %}

<div class="container" style="display: flex">
  <div class="row">
    <div class="col">

      <!--________Table with the top 5 tech stocks__________ -->
      <div class="tableContainer">
        <div class="row table-title">
          <h3>Top Stock Assets</h3>
        </div>

        <table>
          <tr>
            <th class="th-market">#</th>
            <th class="th-market">Stock</th>
            <th class="th-market">Price</th>
            <th class="th-market">52 Week %</th>
          </tr>
          <tr id="TSLA">
            <td class="td-market">1</td>
            <td class="td-market td-hover">Tesla</td>
            <td class="td-market">{{ price[0] }}</td>
            <td class="td-market" style="color:green">{{ ytdChange[0] }}%</td>
            <td class="td-market-btn">
              <a class="btnBuy"><i class="fas fa-angle-double-up fa-sm" disabled></i></a>
            </td>
            <td class="td-market-btn">
              <a class="btnSell"><i class="fas fa-angle-double-down fa-sm"></i></a>
            </td>
          </tr>
          <tr id="AAPL">
            <td class="td-market">2</td>
            <td class="td-market td-hover">Apple</td>
            <td class="td-market">{{ price[1] }}</td>
            <td class="td-market" style="color:green">{{ ytdChange[1] }}%</td>
            <td class="td-market-btn">
              <a class="btnBuy"><i class="fas fa-angle-double-up fa-sm"></i></a>
            </td>
            <td class="td-market-btn">
              <a class="btnSell"><i class="fas fa-angle-double-down fa-sm"></i></a>
            </td>
          </tr>
          <tr id="AMZN">
            <td class="td-market">3</td>
            <td class="td-market td-hover">Amazon</td>
            <td class="td-market">{{ price[2] }}</td>
            <td class="td-market" style="color:green">{{ ytdChange[2] }}%</td>
            <td class="td-market-btn">
              <a class="btnBuy"><i class="fas fa-angle-double-up fa-sm"></i></a>
            </td>
            <td class="td-market-btn">
              <a class="btnSell"><i class="fas fa-angle-double-down fa-sm"></i></a>
            </td>
          </tr>
          <tr id="MSFT">
            <td class="td-market">4</td>
            <td class="td-market td-hover">Microsoft</td>
            <td class="td-market">{{ price[3] }}</td>
            <td class="td-market" style="color:green">{{ ytdChange[3] }}%</td>
            <td class="td-market-btn">
              <a class="btnBuy"><i class="fas fa-angle-double-up fa-sm"></i></a>
            </td>
            <td class="td-market-btn">
              <a class="btnSell"><i class="fas fa-angle-double-down fa-sm"></i></a>
            </td>
          </tr>
          <tr id="FB">
            <td class="td-market">5</td>
            <td class="td-market td-hover">Facebook</td>
            <td class="td-market">{{ price[4] }}</td>
            <td class="td-market" style="color:green">{{ ytdChange[4] }}%</td>
            <td class="td-market-btn">
              <a class="btnBuy"><i class="fas fa-angle-double-up fa-sm"></i></a>
            </td>
            <td class="td-market-btn">
              <a class="btnSell"><i class="fas fa-angle-double-down fa-sm"></i></a>
            </td>
          </tr>
        </table>
      </div>


      <!--_______ Table with the top 5 non stock assets______ -->
      <div class="tableContainer">
        <div class="row table-title">
          <h3>Top Non Stock Assets</h3>
        </div>
        <table>
          <tr>
            <th class="th-market">#</th>
            <th class="th-market">Stock</th>
            <th class="th-market">Price</th>
          </tr>
          <tr id="BTCUSD=X">
            <td class="td-market">1</td>
            <td class="td-market td-hover">Bitcoin</td>
            <td class="td-market">{{ price[5] }}</td>
            <td class="td-fill"></td>
            <td class="td-market-btn">
              <a class="btnBuy"><i class="fas fa-angle-double-up fa-sm"></i></a>
            </td>
            <td class="td-market-btn">
              <a class="btnSell"><i class="fas fa-angle-double-down fa-sm"></i></a>
            </td>
          </tr>
          <tr id="EURUSD=X">
            <td class="td-market">2</td>
            <td class="td-market td-hover">Euro</td>
            <td class="td-market">{{ price[6] }}</td>
            <td class="td-fill"></td>
            <td class="td-market-btn">
              <a class="btnBuy"><i class="fas fa-angle-double-up fa-sm"></i></a>
            </td>
            <td class="td-market-btn">
              <a class="btnSell" href="/"><i class="fas fa-angle-double-down fa-sm"></i></a>
            </td>
          </tr>
          <tr id="^TNX">
            <td class="td-market">3</td>
            <td class="td-market td-hover">10y Bond</td>
            <td class="td-market">{{ price[7] }}</td>
            <td class="td-fill"></td>
            <td class="td-market-btn">
              <a class="btnBuy"><i class="fas fa-angle-double-up fa-sm"></i></a>
            </td>
            <td class="td-market-btn">
              <a class="btnSell"><i class="fas fa-angle-double-down fa-sm"></i></a>
            </td>
          </tr>
          <tr id="CL=F">
            <td class="td-market">4</td>
            <td class="td-market td-hover">Oil</td>
            <td class="td-market">{{ price[8] }}</td>
            <td class="td-fill"></td>
            <td class="td-market-btn">
              <a class="btnBuy"><i class="fas fa-angle-double-up fa-sm"></i></a>
            </td>
            <td class="td-market-btn">
              <a class="btnSell"><i class="fas fa-angle-double-down fa-sm"></i></a>
            </td>
          </tr>
          <tr id="GC=F">
            <td class="td-market">5</td>
            <td class="td-market td-hover">Gold</td>
            <td class="td-market">{{ price[9] }}</td>
            <td class="td-fill"></td>
            <td class="td-market-btn">
              <a class="btnBuy"><i class="fas fa-angle-double-up fa-sm"></i></a>
            </td>
            <td class="td-market-btn">
              <a class="btnSell"><i class="fas fa-angle-double-down fa-sm"></i></a>
            </td>
          </tr>
        </table>
      </div>
    </div>

    <!--__________ Second column containing the graph_________ -->
    <div class="col">
      <div id="graph-container" class="graph-container" style="align-items: center;"><canvas id="canvas" width="500px"
          height="600px"></canvas>
      </div>
    </div>
  </div>
</div>

<!--_______Container with check quote and submit orders_____ -->
<div class="container">

  <div class="row justify-content-md-center">


    <div class="col col-lg-5 check-container">
      <div class="row label-check"><label>Check other quotes</label></div>

      <div class="row input-button-check">
        <div class="col"><input id="input_check" class="inputCheck" name="quote" placeholder="Ticker Symbol"></div>
        <div class="col"><button id="checkPriceBtn" class="default-button"
            onclick="handle_check_button(this)">Check</button></div>
      </div>

      <div class="row label-warning"><label id="label_check" style="visibility: hidden;"></label></div>
    </div>

    <div class="col col-1 second-check-box-container">
      <div class="row"><button id="orderBtn" class="default-button" onclick="process_order(this.id)" disabled>Process
          Order</button></div>
    </div>

  </div>

</div>

<!--_______Container with quote info_____ -->
<div id="quoteInfoContainer">

  <div class="row justify-content-md-center">

    <div class="col col-lg-5 check-container">

      <div class="row row-quote-info-title"><label id="companyName" class="label-quote-info-title"></label>
      </div>

      <div class="row row-quote-info">

        <div class="col">
          <div class="row"><label class="label-quote-info">Price:</label><label class="label-quote-aux">$ </label><label
              id="companyPrice" class="label-quote-info-next"></label></div>
        </div>

        <div class="col">
          <div class="row"><label class="label-quote-info">52 Week Change:</label><label id="fifty2WC"
              class="label-quote-info-next"></label><label class="label-quote-aux">%</label></div>
        </div>

      </div>

      <div class="row row-quote-info">

        <div class="col">
          <div class="row"><label class="label-quote-info">52 Week Low:</label><label class="label-quote-aux">$
            </label><label id="fifty2WL" class="label-quote-info-next"></label></div>
        </div>

        <div class="col">
          <div class="row"><label class="label-quote-info">52 Week High:</label><label class="label-quote-aux">$
            </label><label id="fifty2WH" class="label-quote-info-next"></label></div>
        </div>

      </div>

      <div class="row row-quote-info">

        <div class="col">
          <div class="row"><label class="label-quote-info">trailing PE:</label><label id="trailingPE"
              class="label-quote-info-next"></label></div>
        </div>

        <div class="col">
          <div class="row"><label class="label-quote-info">Asset Type:</label><label id="quoteType"
              class="label-quote-info-next"></label></div>
        </div>

      </div>

    </div>

  </div>

</div>


<!--______________________ POPUP WINDOW ___________________-->
<!-- Container with pop up window -->
<div id="bgmodal" class="bg-modal">

  <div id="load_modal" class="modal-content-load" style="display:flex; justify-content: center;">
    <div class="row rows-login">
      <h1 id="title">Loading</h1>
    </div>
  </div>

  <div id="content_modal" class="modal-content">
    <p id="closeModal" class="crossX" onclick="miniToggleModal()">+</p>
    <div>

      <!-- Windows form with info and input to submit orders -->
      <div class="row row-quote-info">
        <label class="labelModal" id="superLabel"></label>
      </div>      

      <div class="row row-quote-info">
        <label id="labelYTD" class="labelModal"></label>
      </div>

      <div class="row row-quote-info">
        <label id="labelWarningModal" class="labelModal" style="color: red"></label>
      </div>

      <!-- Section with Buttons to BUY, SELL and SUMBIT ORDER -->
      <div class="container contBuySell" style="display: flex; ">
        <div class="row">

          <div class="col">
            <div class="row"><button id="btnBuy" class="default-button button-changes-popup" type="submit"
                onclick="btnActivated(this.id)">Buy</button></div>
            <div class="row"><button id="btnSell" class="default-button button-changes-popup" type="submit"
                onclick="btnActivated(this.id)">Sell</button></div>
          </div>

          <div class="col">
            <!-- Form that submits all info related to buying order-->
            <form id="buyForm" action="/buy" method="post">
              <input id="buy_sell" name="buyOrSell" style="display: none;">
              <input id="tickerInput" name="tickerSymbol" style="display: none;">
              <input id="nameInput" name="tickerName" style="display: none;">
              <input id="assetTypeInput" name="assetType" style="display: none;">
              <input id="sharesInput" class="inputCheck" name="numberShares" placeholder="   How many?"
                style="top: 50px; width: 130px; ">
              <button class="default-button" type="submit" style="width: 130px;" onclick="buyOrder()">Submit
                Order</button>
            </form>
          </div>

        </div>
      </div>

    </div>


    <!-- Section with Buttons to margin buy -->
    <div class="container marginContainer">
      <div class="col"><label class="labelMargin">Trade with Leverage</label></div>
      <div class="row" style="align-items: center;">
        <div class="col"><button class="default-button marginBtn" type="submit" name="margin2x">x2</button></div>
        <div class="col"><button class="default-button marginBtn" type="submit" name="margin5x">x5</button></div>
        <div class="col"><button class="default-button marginBtn" type="submit" name="margin10x">x10</button></div>
      </div>

    </div>

    </form>

  </div>
</div>








<!--__________________ SCRIPT that handles graph bulding _____________-->
<script>


  /* _____________________ Gets data to build graph ___________________*/
  function build_graph(ticker) {
    fetch("http://127.0.0.1:5000/getHistoricalData", {
      method: "POST",
      credentials: "include",
      body: JSON.stringify(ticker),
      cache: "no-cache",
      headers: new Headers({
        "content-type": "application/json"
      })
    })
      .then(response => response.json())
      .then(data => {
        xAxis = data["xAxis"]
        yAxis = data["yAxis"]

        resetGraph();
        do_graph(xAxis, yAxis, ticker)
      })
  }

  /* _____________________ Builds Graph ___________________*/
  function do_graph(xData, yData, ticker) {
    var config = {
      type: 'line',
      data: {
        labels: xData,
        datasets: [{
          label: ticker,
          backgroundColor: "black",
          borderColor: "#17c3b2",
          data: yData,
          fill: false,
        }]
      },
      options: {
        responsive: true,
        title: {
          display: true,
          text: '5 YEAR PERFORMANCE: ' + ticker,
          fontFamily: "SuisseIntl-SemiBold,Helvetica,Arial,sans-serif",
          fontColor: "#00b4d8",
          fontSize: 18,
          lineHeight: 1.5
        },
        tooltips: {
          mode: 'index',
          intersect: false,
        },
        hover: {
          mode: 'nearest',
          intersect: true
        },
        scales: {
          xAxes: [{
            display: true,
            ticks: {
              fontColor: "#a9def9"
            }
          }],
          yAxes: [{
            display: true,
            fontColor: "#17c3b2",
            ticks: {
              fontColor: "#a9def9"
            }
          }]
        },
        legend: {
          display: false
        }
      }

    };
    var ctx = document.getElementById('canvas').getContext('2d');
    window.myLine = new Chart(ctx, config);
  }

  function resetGraph() {
    document.getElementById("canvas").remove();

    var divG = document.getElementById("graph-container");
    var canvas = document.createElement("canvas");

    divG.appendChild(canvas);

    canvas.setAttribute("id", "canvas");
    canvas.setAttribute("width", "500px");
    canvas.setAttribute("height", "500px");
  }
</script>







<!--_ SCRIPT that gets stock related data from server and handles buy order _-->
<script>

  //____________Submits form that handles buy operation_____________
  function buyOrder() {
    
    const sharesInput = document.getElementById("sharesInput")

    if (sharesInput.value === "" || sharesInput.value < 1) {
      event.preventDefault()
      document.getElementById("labelWarningModal").style.visibility = "visible";
      document.getElementById("labelWarningModal").innerHTML = "Please enter a valid number of shares!";
    }
    else {
      document.getElementById("buy_sell").value = order_buy;
      const buyForm = document.getElementById("buyForm");
      buyForm.submit()
    }
  }

  /* ____ Processes order. Fills labels and inputs in modal/popup window */
  function process_order(id) {

    const popup = document.getElementById("bgmodal");
    const input_check = document.getElementById("input_check").value;
    const company_name = document.getElementById("companyName").innerHTML;
    const quote_type = document.getElementById("quoteType").innerHTML;
    const company_price = document.getElementById("companyPrice").innerHTML;
    const fifty2WC = document.getElementById("fifty2WC").innerHTML;

    /* Fills necessary input in the modal/popup window */
    document.getElementById("tickerInput").value = input_check;
    document.getElementById("nameInput").value = company_name;
    document.getElementById("assetTypeInput").value = quote_type;

    document.getElementById("superLabel").innerHTML = "Current price of " + company_name + " is: $" + company_price;
    document.getElementById("labelYTD").innerHTML = "52 Week Change: " + fifty2WC + " %";

    var elmnt = document.getElementById("bgmodal");
    elmnt.scrollIntoView(true); // Scroll to Bottom

    popup.style.visibility = "visible";
  }


  /* Gets quote data from the server and controls some behaviour */
  function get_quote_data(ticker, id) {
    fetch("http://127.0.0.1:5000/getPrice", {
      method: "POST",
      credentials: "include",
      body: JSON.stringify(ticker),
      cache: "no-cache",
      headers: new Headers({
        "content-type": "application/json"
      })
    })
      .then(response => response.json())
      .then(data => {

        /* Controls for invalid ticker symbol */
        if (data == "quote-error") {
          label_check.innerText = "Invalid ticker symbol!";
          label_check.style.visibility = "visible";

          /* Check button behavior */
          document.getElementById(id).innerText = "Check";
          document.getElementById(id).disabled = false;
          block_loads = 0;
          return;
        }

        /* If check button is pressed */
        if (id === "checkPriceBtn") {
          label_check.style.visibility = "hidden";
          label_check.innerHTML = "notFirst";

          var elmnt = document.getElementById("quoteInfoContainer");
          elmnt.scrollIntoView(false); // Scroll to Bottom

          document.getElementById("companyName").innerText = data["companyName"]
          document.getElementById("companyPrice").innerText = data["price"]
          document.getElementById("fifty2WC").innerText = data["fifty2WC"]
          document.getElementById("fifty2WL").innerText = data["fifty2WL"]
          document.getElementById("fifty2WH").innerText = data["fifty2WH"]
          document.getElementById("trailingPE").innerText = data["trailingPE"]
          document.getElementById("quoteType").innerText = data["quoteType"]

          document.getElementById("quoteInfoContainer").style.visibility = "visible"

          /* Check button behavior */
          document.getElementById(id).innerText = "Check"
          document.getElementById(id).disabled = false

          build_graph(ticker)
          document.getElementById("orderBtn").disabled = false;

          const to_disable = document.querySelectorAll(".td-hover");
          to_disable.forEach(x => {
            x.disabled = true;
          })
        }
        if (id == "btnBuy" || id == "btnSell") {

          /* Fills necessary input in the modal/popup window */
          document.getElementById("tickerInput").value = ticker;
          document.getElementById("nameInput").value = data["companyName"];
          document.getElementById("assetTypeInput").value = data["quoteType"];

          document.getElementById("superLabel").innerHTML = "Current price of " + data["companyName"] + " is: $" + data["price"];
          document.getElementById("labelYTD").innerHTML = "52 Week Change: " + data["fifty2WC"] + " %";

          var elmnt = document.getElementById("bgmodal");
          elmnt.scrollIntoView(true); // Scroll to Bottom

          document.getElementById("load_modal").style.display = "none";
          document.getElementById("content_modal").style.display = "block";
        }
        block_loads = 0;
      })

  }

</script>


<!--_________ SCRIPT that handles button behavior ___________-->
<script>


  /* Handles button check behavior */
  function handle_check_button(button) {
    if (block_loads == 1) { return; }
    block_loads = 1;

    const to_disable = document.querySelectorAll(".fas");
    to_disable.forEach(x => {

      x.disabled = true;
    })

    id = button.id;
    const input_check = document.getElementById("input_check");
    const label_check = document.getElementById("label_check");

    /* Controls for empty input field */
    if (input_check.value === "") {
      label_check.innerHTML = "You need to insert a ticket symbol to continue!";
      label_check.style.visibility = "visible";
      block_loads = 0;
      return;
    }
    ticker = input_check.value.toUpperCase();
    input_check.value = ticker;

    button.innerText = "Please Wait..."
    button.disabled = true;

    get_quote_data(ticker, id)
  }


  //_____Closes the popup window and resets buy/sell btn toggle_____
  function miniToggleModal() {
    document.getElementById("bgmodal").style.visibility = "hidden";
    document.getElementById("labelWarningModal").style.visibility = "hidden";
    document.getElementById("btnSell").className = "default-button button-changes-popup";
    document.getElementById("btnBuy").className = "default-button button-changes-popup";

  }


  //_________Activates BUY and SELL button in modal/popup window________
  function btnActivated(id) {
    var other = "";

    if (id === "btnBuy") {
      other = "btnSell";
      order_buy = 1;
    }
    else {
      other = "btnBuy";
      order_buy = 0;
    }

    var toActive = document.getElementById(id);
    var toDesactive = document.getElementById(other);

    var classNameActive = toActive.className;
    var classNameDesactive = toDesactive.className;

    if (classNameActive.match(/active/) === null) {
      toActive.className += " active";
    }

    if (classNameDesactive.match(/active/) !== null) {
      toDesactive.className = "default-button button-changes-popup";
    }
  }



  /*___________________Handles buy/sell buttons on click ______________*/
  $(document).click(function (e) {

    event.preventDefault()

    parentElem = e.target.parentNode;
    id = parentElem.className;

    // Handle only if BUY or SELL buttons are pressed
    if (id === "btnBuy" || id === "btnSell") {
      if (block_loads == 1) { return; }
      block_loads = 1;
      ticker = parentElem.parentNode.parentNode.id;

      // Shows the pop up window
      document.getElementById("bgmodal").style.visibility = "visible";
      document.getElementById("load_modal").style.display = "block";
      document.getElementById("content_modal").style.display = "none";

      get_quote_data(ticker, id)

      // Activates SELL or BUY button in POPUP window
      document.getElementById(id).className += " active";
      document.getElementById("tickerInput").value = ticker;
    }

    if (e.target.className.includes("td-hover")) {
      if (block_loads == 1) { return; }
      block_loads = 1;

      ticker = e.target.parentNode.id;
      id = "checkPriceBtn"

      document.getElementById(id).innerText = "Please Wait..."
      document.getElementById(id).disabled = true;
      document.getElementById("orderBtn").disabled = true;
      document.getElementById("input_check").value = ticker;

      get_quote_data(ticker, id)
    }
  })


</script>










<script>
  let block_loads = 0
  let order_buy = 1 // When processing order, 0 is SELL and 1 is BUY

  window.onload = function () {
    build_graph("TSLA");
  }
</script>

{% endblock %}